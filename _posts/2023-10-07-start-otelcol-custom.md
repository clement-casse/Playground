---
layout: single
categories: [ otelcol-custom ]
title: "Building a Custom OpenTelemetry Collector with Nix - A Starting Point"
tags: [ opentelemetry, otelcol, nix-flake ]
---

In this post, I'll present how to combine *Nix Flakes* with *OpenTelemetry Collector Builder* to create a custom Collector binary only with the components you need.
<!--more-->

> Before that, here is the obligatory picture acting as cover for this post representing a *"halfling assembling a telescope with a blueprint"* that is generated by AI.
> I wanted to illustrate the assembly process of a telescope that is the logo of OpenTelemetry, and the AI returned me a cute little halfling.
{: .notice}

{% include figure
    image_path="/assets/images/halfling-assembling-telescope.jpg"
    alt="AI Generated illustration of an Halfling assembling a telescope"
    caption="Image generated by AI with prompt \"halfling assembling a telescope with a blueprint\"."
%}

# Context and Motivation

## The Big Picture of OpenTelemetry Collector

OpenTelemetry is one of the [CNCF incubating projects](https://www.cncf.io/projects/opentelemetry/), it is a big open-source project that aims to normalize the monitoring of Cloud applications.
Unlike [Prometheus](https://www.cncf.io/projects/prometheus/) or [Jaeger](https://www.cncf.io/projects/jaeger/) which propose technical solutions to store and query respectively metrics and traces emitted by software in Cloud environments, OpenTelemetry takes a complementary approach by proposing a standardized approach for collecting and processing monitoring data before sending them to a particular backend.

Indeed, OpenTelemetry describes itself as:

> OpenTelemetry is a collection of APIs, SDKs, and tools.
> Use it to instrument, generate, collect, and export telemetry data (metrics, logs, and traces) to help you analyse your software’s performance and behaviour.

And, among the *tools* category, lies the *OpenTelemetry Collector*: a standalone process described as a vendor-agnostic way to receive, process and export telemetry data.
This *collector* materializes as different kinds of modules chained together to form a processing pipeline for the different monitoring signals (traces, metrics, logs):

- `receivers` are modules that ingest data in the pipeline, their role is to transpose some specific format in the OpenTelemetry format so they can be processed by further stages in the pipeline.
- `processors` are modules that alter telemetry data that already is in the OpenTelemetry format, this alteration can be like adding/removing some attribute to the data, or simply to propagate the data further in the pipeline or not ...
- `exporters` are modules that convert OpenTelemetry data to another format to send data to a custom backend like, e.g. Jaeger, Amazon CloudWatch, Prometheus, a file in the JSON or CSV format, ...

Other modules exist like `extensions` and `connectors` which will not be detailed in this post but, for the scope of what is presented here, have a similar behaviour.

The number of modules for OpenTelemetry Collector is high and ever increasing as demonstrates the GitHub repository [`open-telemetry/opentelemetry-collector-contrib`](https://github.com/open-telemetry/opentelemetry-collector-contrib) which lists module contributions from the community.
At the time of writing, in this repository, there is **90 receiver modules**, **24 processor modules** and **47 exporter modules**.

Among the companies that have adopted OpenTelemetry, many of them decided to create their own collector only with a selection of modules they want to support in their system.
In the following, we show a list of *distributions* of OpenTelemetry Collectors:
  - [OpenTelemetry Core Collector](https://github.com/open-telemetry/opentelemetry-collector/tree/main/cmd/otelcorecol)
  - [AWS Observability Collector](https://github.com/aws-observability/aws-otel-collector)
  - [Sumo Logic Distribution for OpenTelemetry Collector](https://github.com/SumoLogic/sumologic-otel-collector)

## Creating a Custom Distribution of OpenTelemetry Collector

With this ever-increasing number of modules involved in the code of the OpenTelemetry Collector, it becomes evident that we can speak about **Distributions** of OpenTelmetry Collectors.
We have already seen examples of big actors in the field of observability cherry-picking modules from the community to form a collector compliant with their ecosystem.
Also, it may be a strategic choice for designers of managed services to create their own `receivers`/`exporter` to ease configuration for their end users.

To support all of these scenarios, the OpenTelemetry Collector decided to structure its code base so that making a collector distribution is trivial.
The official documentation present [this process][opentelemetry-docs-build-otelcol] and one of the most prominent contributors of the project also made a [Medium article covering this topic more in depth][krohling-build-own-otelcol].



## Nix Flakes

In another hand, there is [**Nix**](https://nixos.org/).
And behind this name lies a lot of different concepts that are too overwhelming to cover in one single post, indeed Nix is a *package manager*, but also a *language*, and it can also be an *Operating System* on its own.
As I do not want, nor have the knowledge to go into the rabbit hole of *Nix* I am going to only scratch the surface in this post.
In particular, I will focus on the concept of Nix Flakes and present how to use them to build a truly reproducible development environment that would work on my local machine exactly as it would work on a *Continuous Integration* pipeline or on someone else machine (as long as nix is installed).

> [Flakes are] a new Nix feature that improves reproducibility, composability and usability in the Nix ecosystem.
> 
> *-- https://www.tweag.io/blog/2020-05-25-flakes/*

# 

# References

- [OpenTelemetry Documentation Page: Building a custom collector][opentelemetry-docs-build-otelcol]
- [Medium Article: Building your own OpenTelemetry Collector distribution by Juraci Paixão Kröhling][krohling-build-own-otelcol]

[opentelemetry-docs-build-otelcol]: https://opentelemetry.io/docs/collector/custom-collector/
[krohling-build-own-otelcol]: https://medium.com/opentelemetry/building-your-own-opentelemetry-collector-distribution-42337e994b63
